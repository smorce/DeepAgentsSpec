openapi: 3.0.3
info:
  title: Avatar UI Diary Integration Contract
  version: 0.1.0
  description: avatar-ui が提供する日記確定・検索設定の API 契約。
servers:
  - url: http://localhost:1686

components:
  schemas:
    DiaryMessage:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: [user, assistant, system]
        content:
          type: string
        created_at:
          type: string
          format: date-time
          nullable: true
    SearchSettings:
      type: object
      required:
        - enabled
        - top_k
      properties:
        enabled:
          type: boolean
        top_k:
          type: integer
          minimum: 1
          maximum: 10
    DiaryAnalysis:
      type: object
      required:
        - title
        - importance_score
        - summary
        - semantic_memory
        - episodic_memory
      properties:
        title:
          type: string
        importance_score:
          type: integer
          minimum: 1
          maximum: 10
        summary:
          type: string
        semantic_memory:
          type: string
        episodic_memory:
          type: string
    FinalizeDiaryRequest:
      type: object
      required:
        - workspace
        - thread_id
        - messages
        - search_settings
      properties:
        workspace:
          type: string
        thread_id:
          type: string
        messages:
          type: array
          items:
            $ref: '#/components/schemas/DiaryMessage'
        search_settings:
          $ref: '#/components/schemas/SearchSettings'
    FinalizeDiaryResponse:
      type: object
      required:
        - doc_id
        - inserted
        - analysis
      properties:
        doc_id:
          type: string
        inserted:
          type: integer
        analysis:
          $ref: '#/components/schemas/DiaryAnalysis'
    SearchSettingsRequest:
      type: object
      required:
        - thread_id
        - settings
      properties:
        thread_id:
          type: string
        settings:
          $ref: '#/components/schemas/SearchSettings'
    SearchSettingsResponse:
      type: object
      required:
        - applied
      properties:
        applied:
          type: boolean
    ErrorResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string

paths:
  /agui/diary/finalize:
    post:
      summary: 日記会話の確定登録
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FinalizeDiaryRequest'
      responses:
        '200':
          description: 登録成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FinalizeDiaryResponse'
        '400':
          description: 入力不備
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: 依存サービス利用不可
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /agui/diary/search-settings:
    post:
      summary: 検索設定の更新
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchSettingsRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchSettingsResponse'
        '400':
          description: 入力不備
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
